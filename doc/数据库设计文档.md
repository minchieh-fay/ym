# 线下组局平台数据库设计文档

## 1. 数据库概述

- **数据库类型**: PostgreSQL 15+
- **字符集**: UTF-8
- **时区**: Asia/Shanghai
- **命名规范**: 下划线命名法，表名复数形式

## 2. 表结构设计

### 2.1 用户相关表

#### 2.1.1 用户表 (users)
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    phone VARCHAR(20) UNIQUE NOT NULL COMMENT '手机号',
    nickname VARCHAR(50) NOT NULL COMMENT '昵称',
    avatar_url VARCHAR(500) COMMENT '头像URL',
    gender TINYINT DEFAULT 0 COMMENT '性别: 0-未知, 1-男, 2-女',
    birthday DATE COMMENT '生日',
    city VARCHAR(50) COMMENT '所在城市',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用, 1-正常, 2-封禁',
    last_login_at TIMESTAMP COMMENT '最后登录时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);

CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_status ON users(status);
CREATE INDEX idx_users_city ON users(city);
```

#### 2.1.2 用户兴趣标签表 (user_interests)
```sql
CREATE TABLE user_interests (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    interest_tag VARCHAR(20) NOT NULL COMMENT '兴趣标签: 美食, 桌游, 户外, 运动, 咖啡等',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_interests_user_id ON user_interests(user_id);
CREATE INDEX idx_user_interests_tag ON user_interests(interest_tag);
```

#### 2.1.3 用户会员信息表 (user_memberships)
```sql
CREATE TABLE user_memberships (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    membership_type TINYINT NOT NULL COMMENT '会员类型: 1-月度, 2-季度, 3-年度, 4-单次体验',
    start_date TIMESTAMP NOT NULL COMMENT '开始时间',
    end_date TIMESTAMP NOT NULL COMMENT '结束时间',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-过期, 1-有效',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_memberships_user_id ON user_memberships(user_id);
CREATE INDEX idx_user_memberships_status ON user_memberships(status);
CREATE INDEX idx_user_memberships_dates ON user_memberships(start_date, end_date);
```

### 2.2 活动相关表

#### 2.2.1 活动类型表 (activity_types)
```sql
CREATE TABLE activity_types (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(20) NOT NULL COMMENT '类型名称: 晚餐, 剧本杀, 狼人杀, 下午茶, 徒步等',
    icon_url VARCHAR(500) COMMENT '图标URL',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-禁用, 1-启用',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO activity_types (name, sort_order) VALUES 
('晚餐', 1), ('剧本杀', 2), ('狼人杀', 3), ('下午茶', 4), ('徒步', 5);
```

#### 2.2.2 活动表 (activities)
```sql
CREATE TABLE activities (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(100) NOT NULL COMMENT '活动标题',
    description TEXT COMMENT '活动描述',
    cover_url VARCHAR(500) COMMENT '封面图URL',
    activity_type_id BIGINT NOT NULL REFERENCES activity_types(id),
    start_time TIMESTAMP NOT NULL COMMENT '活动开始时间',
    end_time TIMESTAMP COMMENT '活动结束时间',
    location VARCHAR(200) NOT NULL COMMENT '活动地点',
    address VARCHAR(500) COMMENT '详细地址',
    latitude DECIMAL(10, 8) COMMENT '纬度',
    longitude DECIMAL(11, 8) COMMENT '经度',
    max_participants INT NOT NULL DEFAULT 4 COMMENT '最大参与人数',
    current_participants INT DEFAULT 0 COMMENT '当前参与人数',
    fee_type TINYINT DEFAULT 1 COMMENT '费用类型: 1-AA制, 2-免费, 3-固定费用',
    fee_amount DECIMAL(10, 2) DEFAULT 0 COMMENT '费用金额',
    fee_description VARCHAR(200) COMMENT '费用说明',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-草稿, 1-招募中, 2-已满员, 3-已结束, 4-已取消',
    is_member_only BOOLEAN DEFAULT FALSE COMMENT '是否仅会员可见',
    created_by BIGINT NOT NULL COMMENT '创建者ID(运营人员)',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL
);

CREATE INDEX idx_activities_type ON activities(activity_type_id);
CREATE INDEX idx_activities_start_time ON activities(start_time);
CREATE INDEX idx_activities_status ON activities(status);
CREATE INDEX idx_activities_location ON activities(latitude, longitude);
CREATE INDEX idx_activities_member_only ON activities(is_member_only);
```

#### 2.2.3 活动报名表 (activity_registrations)
```sql
CREATE TABLE activity_registrations (
    id BIGSERIAL PRIMARY KEY,
    activity_id BIGINT NOT NULL REFERENCES activities(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status TINYINT DEFAULT 1 COMMENT '状态: 0-已取消, 1-待审核, 2-已通过, 3-已拒绝',
    registration_time TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '报名时间',
    approved_at TIMESTAMP COMMENT '审核通过时间',
    approved_by BIGINT COMMENT '审核人ID',
    rejection_reason VARCHAR(200) COMMENT '拒绝原因',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(activity_id, user_id)
);

CREATE INDEX idx_activity_registrations_activity ON activity_registrations(activity_id);
CREATE INDEX idx_activity_registrations_user ON activity_registrations(user_id);
CREATE INDEX idx_activity_registrations_status ON activity_registrations(status);
```

### 2.3 聊天相关表

#### 2.3.1 聊天室表 (chat_rooms)
```sql
CREATE TABLE chat_rooms (
    id BIGSERIAL PRIMARY KEY,
    activity_id BIGINT NOT NULL REFERENCES activities(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL COMMENT '聊天室名称',
    description VARCHAR(200) COMMENT '聊天室描述',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-已关闭, 1-正常',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_chat_rooms_activity ON chat_rooms(activity_id);
```

#### 2.3.2 聊天室成员表 (chat_room_members)
```sql
CREATE TABLE chat_room_members (
    id BIGSERIAL PRIMARY KEY,
    chat_room_id BIGINT NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_read_at TIMESTAMP COMMENT '最后阅读时间',
    UNIQUE(chat_room_id, user_id)
);

CREATE INDEX idx_chat_room_members_room ON chat_room_members(chat_room_id);
CREATE INDEX idx_chat_room_members_user ON chat_room_members(user_id);
```

#### 2.3.3 聊天消息表 (chat_messages)
```sql
CREATE TABLE chat_messages (
    id BIGSERIAL PRIMARY KEY,
    chat_room_id BIGINT NOT NULL REFERENCES chat_rooms(id) ON DELETE CASCADE,
    sender_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    message_type TINYINT DEFAULT 1 COMMENT '消息类型: 1-文本, 2-图片, 3-表情',
    content TEXT NOT NULL COMMENT '消息内容',
    image_url VARCHAR(500) COMMENT '图片URL',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-已删除, 1-正常',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_chat_messages_room ON chat_messages(chat_room_id);
CREATE INDEX idx_chat_messages_sender ON chat_messages(sender_id);
CREATE INDEX idx_chat_messages_created_at ON chat_messages(created_at);
```

#### 2.3.4 好友关系表 (user_friends)
```sql
CREATE TABLE user_friends (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    friend_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status TINYINT DEFAULT 1 COMMENT '状态: 0-已删除, 1-正常',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, friend_id),
    CHECK(user_id != friend_id)
);

CREATE INDEX idx_user_friends_user ON user_friends(user_id);
CREATE INDEX idx_user_friends_friend ON user_friends(friend_id);
```

### 2.4 支付相关表

#### 2.4.1 订单表 (orders)
```sql
CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    order_no VARCHAR(32) UNIQUE NOT NULL COMMENT '订单号',
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    order_type TINYINT NOT NULL COMMENT '订单类型: 1-活动报名, 2-会员购买',
    activity_id BIGINT REFERENCES activities(id) ON DELETE SET NULL,
    membership_type TINYINT COMMENT '会员类型(当order_type=2时)',
    amount DECIMAL(10, 2) NOT NULL COMMENT '订单金额',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-已取消, 1-待支付, 2-已支付, 3-已退款',
    payment_method TINYINT COMMENT '支付方式: 1-微信支付, 2-支付宝',
    payment_time TIMESTAMP COMMENT '支付时间',
    refund_time TIMESTAMP COMMENT '退款时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_no ON orders(order_no);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_type ON orders(order_type);
```

#### 2.4.2 支付记录表 (payment_records)
```sql
CREATE TABLE payment_records (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    payment_no VARCHAR(64) UNIQUE NOT NULL COMMENT '支付流水号',
    third_party_no VARCHAR(64) COMMENT '第三方支付流水号',
    amount DECIMAL(10, 2) NOT NULL COMMENT '支付金额',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-失败, 1-成功, 2-处理中',
    payment_method TINYINT NOT NULL COMMENT '支付方式',
    callback_data JSONB COMMENT '支付回调数据',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_payment_records_order ON payment_records(order_id);
CREATE INDEX idx_payment_records_payment_no ON payment_records(payment_no);
CREATE INDEX idx_payment_records_third_party ON payment_records(third_party_no);
```

### 2.5 管理相关表

#### 2.5.1 举报记录表 (reports)
```sql
CREATE TABLE reports (
    id BIGSERIAL PRIMARY KEY,
    reporter_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    reported_user_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    reported_message_id BIGINT REFERENCES chat_messages(id) ON DELETE CASCADE,
    report_type TINYINT NOT NULL COMMENT '举报类型: 1-用户, 2-消息',
    reason TINYINT NOT NULL COMMENT '举报原因: 1-骚扰, 2-不当言论, 3-虚假信息, 4-其他',
    description TEXT COMMENT '举报描述',
    status TINYINT DEFAULT 1 COMMENT '状态: 0-已处理, 1-待处理, 2-已忽略',
    handled_by BIGINT COMMENT '处理人ID',
    handled_at TIMESTAMP COMMENT '处理时间',
    handle_result VARCHAR(200) COMMENT '处理结果',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_reports_reporter ON reports(reporter_id);
CREATE INDEX idx_reports_reported_user ON reports(reported_user_id);
CREATE INDEX idx_reports_status ON reports(status);
```

#### 2.5.2 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(50) UNIQUE NOT NULL COMMENT '配置键',
    config_value TEXT NOT NULL COMMENT '配置值',
    description VARCHAR(200) COMMENT '配置描述',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO system_configs (config_key, config_value, description) VALUES 
('max_activity_participants', '8', '活动最大参与人数'),
('min_activity_participants', '2', '活动最小参与人数'),
('activity_advance_hours', '24', '活动提前报名小时数'),
('member_monthly_price', '128', '月度会员价格(分)'),
('member_quarterly_price', '288', '季度会员价格(分)'),
('member_yearly_price', '698', '年度会员价格(分)'),
('member_single_price', '98', '单次体验价格(分)');
```

## 3. 索引优化建议

### 3.1 复合索引
```sql
-- 活动查询优化
CREATE INDEX idx_activities_query ON activities(activity_type_id, status, start_time, is_member_only);

-- 用户活动报名查询
CREATE INDEX idx_registrations_user_activity ON activity_registrations(user_id, activity_id, status);

-- 聊天消息查询优化
CREATE INDEX idx_messages_room_time ON chat_messages(chat_room_id, created_at DESC);
```

### 3.2 分区表建议
```sql
-- 聊天消息表按月分区(数据量大时)
CREATE TABLE chat_messages_202501 PARTITION OF chat_messages
FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
```

## 4. 数据约束和触发器

### 4.1 数据约束
```sql
-- 确保活动参与人数不超过最大值
ALTER TABLE activities ADD CONSTRAINT chk_participants 
CHECK (current_participants <= max_participants);

-- 确保订单金额为正数
ALTER TABLE orders ADD CONSTRAINT chk_amount_positive 
CHECK (amount > 0);

-- 确保会员时间有效
ALTER TABLE user_memberships ADD CONSTRAINT chk_membership_dates 
CHECK (end_date > start_date);
```

### 4.2 触发器示例
```sql
-- 更新活动参与人数
CREATE OR REPLACE FUNCTION update_activity_participants()
RETURNS TRIGGER AS $$
BEGIN
    IF TG_OP = 'INSERT' AND NEW.status = 2 THEN
        UPDATE activities 
        SET current_participants = current_participants + 1 
        WHERE id = NEW.activity_id;
    ELSIF TG_OP = 'UPDATE' AND OLD.status != NEW.status THEN
        IF NEW.status = 2 AND OLD.status != 2 THEN
            UPDATE activities 
            SET current_participants = current_participants + 1 
            WHERE id = NEW.activity_id;
        ELSIF OLD.status = 2 AND NEW.status != 2 THEN
            UPDATE activities 
            SET current_participants = current_participants - 1 
            WHERE id = NEW.activity_id;
        END IF;
    ELSIF TG_OP = 'DELETE' AND OLD.status = 2 THEN
        UPDATE activities 
        SET current_participants = current_participants - 1 
        WHERE id = OLD.activity_id;
    END IF;
    RETURN COALESCE(NEW, OLD);
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_activity_participants
    AFTER INSERT OR UPDATE OR DELETE ON activity_registrations
    FOR EACH ROW EXECUTE FUNCTION update_activity_participants();
```

## 5. 数据备份和恢复策略

### 5.1 备份策略
- **全量备份**: 每日凌晨2点进行全量备份
- **增量备份**: 每4小时进行WAL日志备份
- **备份保留**: 全量备份保留30天，增量备份保留7天

### 5.2 恢复策略
- **RTO目标**: 4小时内恢复服务
- **RPO目标**: 数据丢失不超过1小时

## 6. 性能优化建议

### 6.1 查询优化
- 使用EXPLAIN ANALYZE分析慢查询
- 合理使用索引，避免全表扫描
- 使用连接池减少连接开销

### 6.2 缓存策略
- 活动列表数据缓存30分钟
- 用户信息缓存1小时
- 聊天消息缓存24小时

### 6.3 分库分表策略
- 当用户表超过1000万时考虑分表
- 聊天消息表按月分表
- 订单表按年分表
